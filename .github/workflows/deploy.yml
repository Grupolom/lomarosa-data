name: ğŸ“Š Update Dashboard Lomarosa

on:
  repository_dispatch:
    types: [sharepoint_update]
  
  workflow_dispatch:
  
  push:
    branches: [main]
    paths:
      - 'data/**'
      - 'src/**'
      - 'main.py'
      - '.github/workflows/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl plotly python-dotenv
      
      - name: ğŸ“ Create required directories
        run: |
          mkdir -p data output
          echo "âœ… Directorios creados"
      
      # â† NUEVO PASO: Descargar archivos de OneDrive
      - name: ğŸ“¥ Download files from OneDrive
        run: |
          echo "ğŸ“¥ Descargando archivos desde OneDrive..."
          
          # Descargar inventario
          if [ -n "${{ secrets.ONEDRIVE_INVENTARIO_URL }}" ]; then
            echo "Descargando INVENTARIO_LOMAROSA.xlsx..."
            curl -L "${{ secrets.ONEDRIVE_INVENTARIO_URL }}" -o data/INVENTARIO_LOMAROSA.xlsx
            echo "âœ… Inventario descargado"
          else
            echo "âš ï¸ ONEDRIVE_INVENTARIO_URL no configurado, usando archivos locales"
          fi
          
          # Descargar consolidado
          if [ -n "${{ secrets.ONEDRIVE_CONSOLIDADO_URL }}" ]; then
            echo "Descargando consolidado.xlsx..."
            curl -L "${{ secrets.ONEDRIVE_CONSOLIDADO_URL }}" -o data/consolidado.xlsx
            echo "âœ… Consolidado descargado"
          else
            echo "âš ï¸ ONEDRIVE_CONSOLIDADO_URL no configurado, usando archivos locales"
          fi
          
          echo "ğŸ“‚ Contenido de data/:"
          ls -lah data/
      
      - name: ğŸ” Verify environment
        run: |
          echo "Python version: $(python --version)"
          echo "Current directory: $(pwd)"
          echo "Files in repo:"
          ls -la
          echo ""
          echo "Files in data/:"
          ls -la data/ || echo "âš ï¸ Carpeta data/ vacÃ­a o no existe"
      
      - name: ğŸ“Š Generate dashboard
        run: |
          python src/main.py
        env:
          GITHUB_ACTIONS: 'true'
      
      - name: âœ… Verify output
        run: |
          echo "=== Archivos generados en output/ ==="
          if [ -d "output" ]; then
            ls -lah output/
            if [ -f "output/index.html" ]; then
              echo "âœ… Dashboard HTML generado correctamente"
              echo "TamaÃ±o: $(du -h output/index.html | cut -f1)"
            else
              echo "âŒ No se encontrÃ³ output/index.html"
              exit 1
            fi
          else
            echo "âŒ Carpeta output/ no existe"
            exit 1
          fi
      
      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸ”„ Update dashboard - ${{ github.event.head_commit.message }}'
          
      - name: ğŸ‰ Success notification
        if: success()
        run: |
          echo "=========================================="
          echo "âœ… Dashboard actualizado exitosamente!"
          echo "ğŸŒ URL: https://grupolom.github.io/lomarosa-data/"
          echo "=========================================="
