<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Recordatorios de Pago - Cartera</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            padding: 2rem;
            line-height: 1.4;
        }

        h1 {
            margin-top: 0;
            font-size: 1.4rem;
            color: #38bdf8;
        }

        .card {
            background: #1e253a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 20px 40px rgb(0 0 0 / 0.6);
        }

        label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #e2e8f0;
            display: block;
            margin-bottom: 0.4rem;
        }

        input[type="file"] {
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            width: 100%;
            color: #f8fafc;
            font-size: 0.9rem;
        }

        button {
            background: #38bdf8;
            color: #0f172a;
            font-weight: 600;
            border: 0;
            border-radius: 8px;
            padding: 0.7rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        button:disabled {
            background: #475569;
            color: #94a3b8;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.8rem;
        }

        th,
        td {
            border: 1px solid #475569;
            padding: 0.5rem 0.6rem;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #1e293b;
            color: #7dd3fc;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: .03em;
        }

        .footer-note {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 2rem;
        }

        .warning {
            color: #facc15;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
    </style>
</head>

<body>

    <h1>Recordatorios de Pago · Cartera Preventiva</h1>

    <div class="card">
        <label for="fileClientes">1. Subir Excel de Proveedores (hoja "Proveedores")</label>
        <input type="file" id="fileClientes" accept=".xlsx,.xls" />
        <div class="warning">
            Debe tener columnas: "CODIGO PROV", "CONDICION DE PAGO", "Correo".<br />
            Se ignora la primera fila. La segunda fila son los encabezados reales.
        </div>
    </div>

    <div class="card">
        <label for="fileFacturas">2. Subir Excel de Facturas / Consolidado (hoja "sheet1")</label>
        <input type="file" id="fileFacturas" accept=".xlsx,.xls" />
        <div class="warning">
            Debe tener columnas: "nit", "Documento", "Fecha". Opcional: "ValorFactura", "Pagada".
        </div>
    </div>

    <div class="card">
        <button id="processBtn" disabled>3. Procesar y generar recordatorios</button>
        <div id="status" class="warning"></div>
    </div>

    <div class="card" id="resultsCard" style="display:none;">
        <h2 style="color:#7dd3fc; font-size:1rem; margin-top:0;">Facturas que necesitan recordatorio (hoy + próximos 3
            días)</h2>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Correo destino</th>
                    <th>NIT</th>
                    <th>Factura</th>
                    <th>Fecha factura</th>
                    <th>Vencimiento</th>
                    <th>Recordar el</th>
                    <th>Valor</th>
                    <th>Mensaje correo</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button id="downloadBtn">Descargar CSV para Power Automate</button>
    </div>

    <div class="footer-note">
        Todo se procesa local en tu navegador. Nada se sube a internet.<br />
        Luego subes el CSV a la carpeta que lee Power Automate.
    </div>

    <!-- Librerías que necesita el navegador para leer Excel y manejar fechas -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <script>
        function cleanNIT(v) {
            if (v === null || v === undefined) return "";
            return String(v).trim().toLowerCase();
        }

        function plazoDiasFromTexto(raw) {
            if (!raw) return 0;
            const txt = String(raw).trim().toLowerCase();

            const mapa = {
                "contado": 0,
                "de contado": 0,
                "contado contraentrega": 0,
                "8 dias": 8,
                "8 días": 8,
                "8 dÃ­as": 8,
                "15 dias": 15,
                "15 días": 15,
                "15 dÃ­as": 15,
                "20 dias": 20,
                "20 días": 20,
                "20 dÃ­as": 20,
                "30 dias": 30,
                "30 días": 30,
                "30 dÃ­as": 30,
                "45 dias": 45,
                "45 días": 45,
                "45 dÃ­as": 45,
                "60 dias": 60,
                "60 días": 60,
                "60 dÃ­as": 60
            };

            return mapa[txt] !== undefined ? mapa[txt] : 0;
        }

        function readWorkbook(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: "array" });
                    resolve(wb);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function parseClientesWorkbook(wb) {
            const ws = wb.Sheets["Proveedores"];
            if (!ws) {
                throw new Error('No se encontró la hoja "Proveedores"');
            }
            // header:1 => lo leemos como matriz [ [fila1...], [fila2...], ...]
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

            const headers = rows[1];        // fila 2 = encabezados reales
            const dataRows = rows.slice(2); // datos reales desde fila 3

            const idxNit = headers.findIndex(h => String(h).trim().toLowerCase() === "codigo prov");
            const idxCond = headers.findIndex(h => String(h).trim().toLowerCase() === "condicion de pago");
            const idxMail = headers.findIndex(h => String(h).trim().toLowerCase() === "correo");

            const clientes = {};

            dataRows.forEach(r => {
                const nitRaw = r[idxNit];
                if (!nitRaw) return;
                const nit = cleanNIT(nitRaw);
                const condicion = r[idxCond];
                const correo = r[idxMail];

                clientes[nit] = {
                    nit,
                    plazoDias: plazoDiasFromTexto(condicion),
                    correo: correo || ""
                };
            });

            return clientes;
        }

        function excelDateToDayjs(v) {
            if (v instanceof Date) {
                return dayjs(v);
            }
            return dayjs(v); // si viene string tipo "2025-10-25"
        }

        function parseFacturasWorkbook(wb) {
            const ws = wb.Sheets["sheet1"];
            if (!ws) {
                throw new Error('No se encontró la hoja "sheet1"');
            }
            // acá sí lo leo como objetos con encabezado en la primera fila de la hoja
            const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

            return rows.map(row => ({
                nit: cleanNIT(row["nit"]),
                numero_factura: row["Documento"],
                fecha_factura_raw: row["Fecha"],
                valor_factura: row["ValorFactura"] || row["Valor"] || row["valor"] || "",
                pagada: row["Pagada"] || row["pagada"] || row["PAGADA"] || "No"
            }));
        }

        function buildRecordatorios(clientesMap, facturasList) {
            const hoy = dayjs().startOf("day");
            const out = [];

            facturasList.forEach(f => {
                const cli = clientesMap[f.nit];
                if (!cli) return;

                // si ya está pagada, no se le escribe
                if (String(f.pagada).toLowerCase().trim() === "si") return;

                const fechaFactura = excelDateToDayjs(f.fecha_factura_raw);
                if (!fechaFactura.isValid()) return;

                const plazo = cli.plazoDias || 0;

                const fechaVenc = fechaFactura.add(plazo, "day");
                const fechaRec = fechaVenc.subtract(3, "day");

                const diffDias = fechaRec.diff(hoy, "day");
                const dentroVentana =
                    diffDias === 0 || (diffDias > 0 && diffDias <= 3);

                if (!dentroVentana) return;

                const mensaje = [
                    "Buen día,\n\n",
                    `Este es un recordatorio de pago para la factura ${f.numero_factura}, `,
                    `emitida el ${fechaFactura.format("YYYY-MM-DD")} `,
                    `con vencimiento el ${fechaVenc.format("YYYY-MM-DD")}.\n\n`,
                    `Valor pendiente: ${f.valor_factura || "[monto no especificado]"}.\n\n`,
                    "Agradecemos realizar el pago oportunamente.\n\n",
                    "Saludos,\nCartera."
                ].join("");

                out.push({
                    correo: cli.correo,
                    nit: f.nit,
                    numero_factura: f.numero_factura,
                    fecha_factura: fechaFactura.format("YYYY-MM-DD"),
                    fecha_vencimiento: fechaVenc.format("YYYY-MM-DD"),
                    fecha_recordatorio: fechaRec.format("YYYY-MM-DD"),
                    valor_factura: f.valor_factura,
                    mensaje_correo: mensaje
                });
            });

            return out;
        }

        function renderResults(rows) {
            const card = document.getElementById("resultsCard");
            const tbody = document.querySelector("#resultsTable tbody");
            tbody.innerHTML = "";

            if (!rows.length) {
                tbody.innerHTML = `<tr><td colspan="8" style="color:#94a3b8;">No hay facturas para recordar en la ventana (hoy +3 días).</td></tr>`;
                card.style.display = "block";
                return;
            }

            rows.forEach(r => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${r.correo || ""}</td>
          <td>${r.nit || ""}</td>
          <td>${r.numero_factura || ""}</td>
          <td>${r.fecha_factura || ""}</td>
          <td>${r.fecha_vencimiento || ""}</td>
          <td>${r.fecha_recordatorio || ""}</td>
          <td>${r.valor_factura || ""}</td>
          <td style="white-space:pre-line;">${r.mensaje_correo || ""}</td>
        `;
                tbody.appendChild(tr);
            });

            card.style.display = "block";
        }

        function downloadCSV(rows) {
            if (!rows.length) {
                alert("No hay datos para descargar.");
                return;
            }

            const headers = Object.keys(rows[0]);
            const lines = [];
            lines.push(headers.join(","));

            rows.forEach(r => {
                const vals = headers.map(h => {
                    const val = r[h] == null ? "" : String(r[h]);
                    if (val.includes(",") || val.includes("\n") || val.includes('"')) {
                        return '"' + val.replace(/"/g, '""') + '"';
                    }
                    return val;
                });
                lines.push(vals.join(","));
            });

            const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "recordatorios_cartera.csv";
            a.click();

            URL.revokeObjectURL(url);
        }

        let fileClientesObj = null;
        let fileFacturasObj = null;
        let resultadosGlobal = [];

        const fileClientesInput = document.getElementById("fileClientes");
        const fileFacturasInput = document.getElementById("fileFacturas");
        const processBtn = document.getElementById("processBtn");
        const statusEl = document.getElementById("status");
        const downloadBtn = document.getElementById("downloadBtn");

        fileClientesInput.addEventListener("change", e => {
            fileClientesObj = e.target.files[0] || null;
            checkReady();
        });

        fileFacturasInput.addEventListener("change", e => {
            fileFacturasObj = e.target.files[0] || null;
            checkReady();
        });

        function checkReady() {
            if (fileClientesObj && fileFacturasObj) {
                processBtn.disabled = false;
                statusEl.textContent = "";
            } else {
                processBtn.disabled = true;
                statusEl.textContent = "Sube ambos archivos para continuar.";
            }
        }

        processBtn.addEventListener("click", async () => {
            statusEl.textContent = "Procesando...";
            try {
                const wbClientes = await readWorkbook(fileClientesObj);
                const wbFacturas = await readWorkbook(fileFacturasObj);

                const clientesMap = parseClientesWorkbook(wbClientes);
                const facturasList = parseFacturasWorkbook(wbFacturas);

                resultadosGlobal = buildRecordatorios(clientesMap, facturasList);

                renderResults(resultadosGlobal);
                statusEl.textContent = "Listo. Revisa abajo los recordatorios generados 👇";
            } catch (err) {
                console.error(err);
                statusEl.textContent = "Error procesando archivos. Revisa nombres de hojas y columnas.";
            }
        });

        downloadBtn.addEventListener("click", () => {
            downloadCSV(resultadosGlobal);
        });
    </script>
</body>

</html>